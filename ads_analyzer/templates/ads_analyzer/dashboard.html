{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdPerformance Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #9ca3af;
        }
    </style>
</head>

<body class="p-6">

    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-white">AdPerformance Executive Overview</h1>
            <p class="text-gray-400">Q1 2023 Performance Data (Indonesia Market)</p>
        </div>
        <div class="bg-gray-800 px-4 py-2 rounded text-sm text-gray-300">
            Status: <span class="text-green-400 font-bold">Online</span> | Data Validated
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card">
            <div class="stat-label">Total Revenue (GMV)</div>
            <div class="stat-value">IDR {{ summary_stats.total_revenue|idr_currency }}</div>
        </div>
        <div class="card">
            <div class="stat-label">Total Spend</div>
            <div class="stat-value">IDR {{ summary_stats.total_spend|idr_currency }}</div>
        </div>
        <div class="card">
            <div class="stat-label">Overall ROAS</div>
            <div class="stat-value">{{ summary_stats.overall_roas|floatformat:2 }}x</div>
        </div>
        <div class="card border-l-4 border-blue-500">
            <div class="stat-label">Data Health</div>
            <div class="text-blue-400 font-bold">{{ anomalies_count }} Anomalies Fixed (SciPy/Pandas)</div>
        </div>
    </div>

    <!-- Deep Dive Metrics Row (Weighted Averages) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card bg-gray-800 border border-gray-700">
            <div class="stat-label mb-1">CTR (Click-Through Rate)</div>
            <div class="text-2xl font-bold text-yellow-400">{{ deep_dive_metrics.ctr|floatformat:2 }}%</div>
            <div class="text-xs text-gray-500">Global Average</div>
        </div>
        <div class="card bg-gray-800 border border-gray-700">
            <div class="stat-label mb-1">CPC (Cost Per Click)</div>
            <div class="text-2xl font-bold text-blue-400">IDR {{ deep_dive_metrics.cpc|idr_currency }}</div>
            <div class="text-xs text-gray-500">Global Weighted Avg</div>
        </div>
        <div class="card bg-gray-800 border border-gray-700">
            <div class="stat-label mb-1">CVR (Conversion Rate)</div>
            <div class="text-2xl font-bold text-green-400">{{ deep_dive_metrics.cvr|floatformat:2 }}%</div>
            <div class="text-xs text-gray-500">Purchases / Link Clicks</div>
        </div>
        <div class="card bg-gray-800 border border-gray-700">
            <div class="stat-label mb-1">AOV (Avg Order Value)</div>
            <div class="text-2xl font-bold text-purple-400">IDR {{ deep_dive_metrics.aov|idr_currency }}</div>
            <div class="text-xs text-gray-500">Revenue / Purchases</div>
        </div>
    </div>

    <!-- Section: Monthly Global Trends (Modul 2) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- Monthly Financials (Spend vs Revenue vs Calculate Monthly ROAS) -->
        <div class="card h-[450px]">
            <h2 class="text-xl font-bold mb-4 text-white">Monthly Financial Performance</h2>
            <div id="monthly-financial-chart" class="h-[380px]"></div>
        </div>

        <!-- Monthly Efficiency (CTR vs CVR) -->
        <div class="card h-[450px]">
            <h2 class="text-xl font-bold mb-4 text-white">Monthly Efficiency Trends</h2>
            <div id="monthly-efficiency-chart" class="h-[380px]"></div>
        </div>
    </div>
    <div class="card mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Annual Revenue & Spend Trend (Jan - Dec 2023)</h2>
            <div class="text-sm text-gray-400">Includes Ramadan & Harbolnas Events</div>
        </div>
        <div id="main-chart" style="width:100%;height:500px;"></div>
    </div>

    <!-- Section 2: Funnel & Correlation Analysis (Modul 3) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Funnel Analysis (65% width) -->
        <div class="card col-span-2">
            <h2 class="text-xl font-bold mb-4 text-white">Conversion Funnel Analysis</h2>
            <div id="funnel-chart" style="width:100%;height:400px;"></div>

            <!-- Conversion Efficiency Cards (Step-by-Step Rates) -->
            <div class="grid grid-cols-4 gap-4 mt-4 text-center">
                <div class="bg-gray-800 p-2 rounded">
                    <div class="text-xs text-gray-400">Hook Rate</div>
                    <div class="text-lg font-bold text-yellow-400">{{ funnel_rates.hook_rate|floatformat:2 }}%</div>
                    <div class="text-[10px] text-gray-500">Click / Imp</div>
                </div>
                <div class="bg-gray-800 p-2 rounded">
                    <div class="text-xs text-gray-400">LP Rate</div>
                    <div class="text-lg font-bold text-blue-400">{{ funnel_rates.lp_rate|floatformat:2 }}%</div>
                    <div class="text-[10px] text-gray-500">View / Link</div>
                </div>
                <div class="bg-gray-800 p-2 rounded">
                    <div class="text-xs text-gray-400">ATC Rate</div>
                    <div class="text-lg font-bold text-pink-400">{{ funnel_rates.atc_rate|floatformat:2 }}%</div>
                    <div class="text-[10px] text-gray-500">ATC / View</div>
                </div>
                <div class="bg-gray-800 p-2 rounded">
                    <div class="text-xs text-gray-400">Close Rate</div>
                    <div class="text-lg font-bold text-green-400">{{ funnel_rates.close_rate|floatformat:2 }}%</div>
                    <div class="text-[10px] text-gray-500">Pur / ATC</div>
                </div>
            </div>
        </div>

        <!-- Correlation Matrix (35% width) -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-white">Correlation Matrix</h2>
            <div id="heatmap-chart" style="width:100%;height:400px;"></div>
            <p class="text-xs text-gray-400 mt-2">
                *Insight: Red squares indicate strong positive correlation. Check if "Amount Spent" correlates strongly
                with "Purchase Value".
            </p>
        </div>
    </div>

    <!-- Section 3: AI Strategic Budget Allocation -->
    <div class="card mb-4 bg-gradient-to-r from-green-900/20 to-blue-900/20 border border-green-500/30">
        <div class="grid grid-cols-3 gap-4 text-center">
            <div>
                <div class="text-sm text-gray-400 mb-1">Current Projected Revenue</div>
                <div class="text-2xl font-bold text-white">IDR {{ optimization_metrics.current_revenue|idr_currency }}
                </div>
            </div>
            <div class="border-l border-r border-gray-700">
                <div class="text-sm text-gray-400 mb-1">Optimized Revenue (AI Forecast)</div>
                <div class="text-2xl font-bold text-green-400">IDR {{
                    optimization_metrics.optimized_revenue|idr_currency }}</div>
            </div>
            <div>
                <div class="text-sm text-gray-400 mb-1">Potential Uplift</div>
                <div class="text-3xl font-bold text-green-400">+{{ optimization_metrics.uplift_percentage|floatformat:1
                    }}%</div>
                <div class="text-xs text-gray-500">IDR {{ optimization_metrics.uplift_absolute|idr_currency }}</div>
            </div>
        </div>
    </div>

    <!-- Section 2.5: Comparison Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- Industry Comparison Chart -->
        <div class="card h-[400px]">
            <h2 class="text-xl font-bold mb-4 text-purple-400">Industry Monthly Trends (Seasonality)</h2>
            <div id="industry-chart" class="h-[320px]"></div>
        </div>

        <!-- Objective Comparison Chart -->
        <div class="card h-[400px]">
            <h2 class="text-xl font-bold mb-4 text-blue-400">Campaign Objective Analysis</h2>
            <div id="objective-chart" class="h-[320px]"></div>
        </div>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-bold mb-6 text-green-400">AI Strategic Budget Allocation (2024 Forecast)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">

            <!-- Pie Charts -->
            <div class="flex flex-col md:flex-row justify-around">
                <div class="w-full md:w-1/2">
                    <h3 class="text-center text-sm mb-2 text-gray-400">2023 Actual Allocation</h3>
                    <div id="pie-actual" style="width:100%;height:300px;"></div>
                </div>
                <div class="w-full md:w-1/2 relative">
                    <h3 class="text-center text-sm mb-2 text-green-400 font-bold">2024 Optimized Plan</h3>
                    <div id="pie-recommended" style="width:100%;height:300px;"></div>
                    <!-- Arrow overlay could be CSS, but simpler to just show side by side -->
                </div>
            </div>

            <!-- Recommendation Table -->
            <div>
                <p class="text-sm text-gray-400 mb-4">
                    Based on 2023 ROAS data, the SciPy optimizer recommends shifting budget towards high-ROAS categories
                    (Beauty/Fashion) to achieve a projected <span class="text-green-400 font-bold">+22% Revenue
                        Lift</span>.
                </p>
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-800 text-gray-400">
                        <tr>
                            <th class="p-2">Channel</th>
                            <th class="p-2">Hist. ROAS</th>
                            <th class="p-2">Rec. Spend/Day</th>
                            <th class="p-2">Proj. Revenue</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for opt in optimization %}
                        <tr class="hover:bg-gray-700">
                            <td class="p-2 font-bold">{{ opt.channel }}</td>
                            <td class="p-2 text-blue-300">{{ opt.roas|floatformat:2 }}x</td>
                            <td class="p-2">IDR {{ opt.suggested_spend|idr_currency }}</td>
                            <td class="p-2 text-green-300">IDR {{ opt.projected_revenue|idr_currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JSON Data for Plotly -->
    {{ chart_data_json|json_script:"chart-data" }}
    {{ funnel_data_json|json_script:"funnel-data" }}
    {{ allocation_data.actual|json_script:"alloc-actual" }}
    {{ allocation_data.recommended|json_script:"alloc-rec" }}
    {{ industry_monthly_json|json_script:"industry-monthly-data" }}
    {{ objective_chart_json|json_script:"objective-chart-data" }}
    {{ monthly_trend_json|json_script:"monthly-trend-data" }}
    {{ funnel_abs|json_script:"funnel-abs-data" }}
    {{ heatmap_json|json_script:"heatmap-data" }}

    <script>
        // ... (Existing chart logic) ...
        const chartData = JSON.parse(document.getElementById('chart-data').textContent);
        // ... Code for Main Trend Chart ...

        // NEW: Modul 3 Funnel Chart (Absolute Numbers)
        const fAbs = JSON.parse(document.getElementById('funnel-abs-data').textContent);
        const traceFunnel = {
            type: 'funnel',
            y: ['Impressions', 'Clicks', 'Link Clicks', 'Content Views', 'Add to Cart', 'Purchases'],
            x: [
                fAbs.impressions, fAbs.clicks, fAbs.link_clicks,
                fAbs.content_views, fAbs.add_to_cart, fAbs.purchases
            ],
            textinfo: "value+percent previous",
            textposition: "inside",
            hoverinfo: "label+value+percent initial",
            marker: {
                color: ["#6366f1", "#8b5cf6", "#d946ef", "#ec4899", "#f43f5e", "#10b981"]
            }
        };
        Plotly.newPlot('funnel-chart', [traceFunnel], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            margin: { l: 120, r: 20, t: 30, b: 20 }
        }, { responsive: true });

        // NEW: Modul 3 Correlation Heatmap
        const hData = JSON.parse(document.getElementById('heatmap-data').textContent);
        const traceHeatmap = {
            z: hData.z,
            x: hData.x,
            y: hData.y,
            type: 'heatmap',
            colorscale: 'RdBu',
            zmid: 0,
            showscale: true
        };
        Plotly.newPlot('heatmap-chart', [traceHeatmap], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            margin: { l: 100, b: 80, t: 20, r: 20 },
            xaxis: { tickangle: -45 }
        }, { responsive: true });

        // ... (Existing Monthly Trend Logic) ...
        const mTrend = JSON.parse(document.getElementById('monthly-trend-data').textContent);

        // Chart 1: Financials (Bar Spend/Rev + Line ROAS)
        const trM_Rev = { x: mTrend.months, y: mTrend.revenue, name: 'Revenue', type: 'bar', marker: { color: '#4ade80' } };
        const trM_Spd = { x: mTrend.months, y: mTrend.spend, name: 'Spend', type: 'bar', marker: { color: '#60a5fa' } };
        const trM_Roas = {
            x: mTrend.months, y: mTrend.roas, name: 'ROAS', type: 'scatter', mode: 'lines+markers',
            yaxis: 'y2', line: { color: '#f59e0b', width: 3 }, marker: { size: 6 }
        };

        Plotly.newPlot('monthly-financial-chart', [trM_Spd, trM_Rev, trM_Roas], {
            barmode: 'group',
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            yaxis: { gridcolor: '#374151', title: 'IDR', tickformat: ',.0f' },
            yaxis2: {
                title: 'ROAS', overlaying: 'y', side: 'right', gridcolor: 'rgba(0,0,0,0)',
                tickformat: '.2f', range: [0, Math.max(...mTrend.roas) * 1.2]
            },
            legend: { orientation: 'h', y: 1.1 },
            margin: { t: 40, l: 60, r: 50, b: 40 }
        }, { responsive: true });

        // Chart 2: Efficiency (Line CTR & CVR)
        const trM_Ctr = {
            x: mTrend.months, y: mTrend.ctr, name: 'CTR %', type: 'scatter', mode: 'lines+markers',
            line: { color: '#facc15', width: 3 }, marker: { size: 6 }
        };
        const trM_Cvr = {
            x: mTrend.months, y: mTrend.cvr, name: 'CVR %', type: 'scatter', mode: 'lines+markers',
            yaxis: 'y2', line: { color: '#34d399', width: 3 }, marker: { size: 6 }
        };

        Plotly.newPlot('monthly-efficiency-chart', [trM_Ctr, trM_Cvr], {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            yaxis: { gridcolor: '#374151', title: 'CTR %' },
            yaxis2: {
                title: 'CVR %', overlaying: 'y', side: 'right', gridcolor: 'rgba(0,0,0,0)',
            },
            legend: { orientation: 'h', y: 1.1 },
            margin: { t: 40, l: 50, r: 50, b: 40 }
        }, { responsive: true });

        // ... (Existing charts below) ...

        const traceRevenue = {
            x: chartData.dates, y: chartData.revenue, type: 'scatter', mode: 'lines', name: 'Revenue',
            line: { color: '#4ade80', width: 2 },
            hovertemplate: 'Revenue: IDR %{y:,.0f}<extra></extra>'
        };
        const traceSpend = {
            x: chartData.dates, y: chartData.traffic_spend.map((v, i) => v + chartData.sales_spend[i]),
            type: 'scatter', mode: 'lines', name: 'Total Spend',
            line: { color: '#60a5fa', width: 2 }, fill: 'tozeroy', fillcolor: 'rgba(96, 165, 250, 0.1)',
            hovertemplate: 'Spend: IDR %{y:,.0f}<extra></extra>'
        };

        const traceROAS = {
            x: chartData.dates, y: chartData.roas, type: 'scatter', mode: 'lines', name: 'ROAS',
            line: { color: '#f59e0b', width: 2, dash: 'dot' },
            yaxis: 'y2',
            hovertemplate: 'ROAS: %{y:.2f}x<extra></extra>'
        };

        const layoutTrend = {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            xaxis: { gridcolor: '#374151', title: 'Date' },
            yaxis: {
                gridcolor: '#374151',
                title: 'IDR',
                separatethousands: true,
                tickformat: ',.0f'
            },
            yaxis2: {
                title: 'ROAS',
                font: { color: '#f59e0b' },
                overlaying: 'y',
                side: 'right',
                gridcolor: 'rgba(0,0,0,0)',
                range: [0, Math.max(...chartData.roas) * 1.5],
                tickformat: '.2f'
            },
            margin: { t: 20, l: 80, r: 60, b: 60 },
            legend: { orientation: 'h', y: 1.1 },
            hovermode: 'x unified',
            annotations: [
                { x: '2023-04-15', y: Math.max(...chartData.revenue) * 0.8, xref: 'x', yref: 'y', text: 'Ramadan Peak', showarrow: true, arrowhead: 1, ax: 0, ay: -40 },
                { x: '2023-11-11', y: Math.max(...chartData.revenue) * 0.9, xref: 'x', yref: 'y', text: '11.11 Sales', showarrow: true, arrowhead: 1, ax: 0, ay: -40 }
            ]
        };
        Plotly.newPlot('main-chart', [traceSpend, traceRevenue, traceROAS], layoutTrend, { responsive: true });


        // 1.5 Industry Comparison Chart (Stacked Bar by Month)
        const indMonthlyData = JSON.parse(document.getElementById('industry-monthly-data').textContent);

        Plotly.newPlot('industry-chart', indMonthlyData, {
            barmode: 'stack', // Stacked to show total while differentiating sectors
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            margin: { t: 20, l: 60, r: 20, b: 40 },
            yaxis: { gridcolor: '#374151', title: 'Revenue', tickformat: ',.0f' }
        }, { responsive: true });


        // 1.6 Objective Comparison Chart
        const objData = JSON.parse(document.getElementById('objective-chart-data').textContent);
        const traceObjSpent = {
            x: objData.labels, y: objData.spend, name: 'Spend', type: 'bar', marker: { color: '#f472b6' }
        };
        const traceObjRev = {
            x: objData.labels, y: objData.revenue, name: 'Revenue', type: 'bar', marker: { color: '#22d3ee' }
        };
        Plotly.newPlot('objective-chart', [traceObjSpent, traceObjRev], {
            barmode: 'group',
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            margin: { t: 20, l: 60, r: 20, b: 40 },
            yaxis: { gridcolor: '#374151', title: 'IDR', tickformat: ',.0f' }
        }, { responsive: true });

        // 3. Allocation Pie Charts
        const allocActual = JSON.parse(document.getElementById('alloc-actual').textContent);
        const allocRec = JSON.parse(document.getElementById('alloc-rec').textContent);

        const pieLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#9ca3af' },
            margin: { t: 0, b: 0, l: 0, r: 0 }, showlegend: false
        };

        Plotly.newPlot('pie-actual', [{
            values: allocActual.map(d => d.value), labels: allocActual.map(d => d.label),
            type: 'pie', hole: 0.4, textinfo: 'label+percent', marker: { colors: ['#6366f1', '#ec4899', '#14b8a6'] }
        }], pieLayout, { responsive: true });

        Plotly.newPlot('pie-recommended', [{
            values: allocRec.map(d => d.value), labels: allocRec.map(d => d.label),
            type: 'pie', hole: 0.4, textinfo: 'label+percent', marker: { colors: ['#6366f1', '#ec4899', '#14b8a6'] }
        }], pieLayout, { responsive: true });

    </script>
</body>

</html>